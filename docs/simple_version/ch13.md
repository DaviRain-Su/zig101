# Zig 文件系统和 IO 操作指南

## IO 基础

### 标准通道
- **stdout/stdin/stderr**：操作系统为每个进程提供的标准输出、输入和错误通道
- 通过 `std.fs.File.stdout()`, `std.fs.File.stdin()`, `std.fs.File.stderr()` 访问

### Reader/Writer 模式
Zig 中所有 IO 操作都通过 `Reader` 或 `Writer` 对象进行：

```zig
// 写入 stdout
var buffer: [1024]u8 = undefined;
var writer = std.fs.File.stdout().writer(&buffer);
try writer.writeAll("Hello World\n");
try writer.flush();  // 重要：刷新缓冲区

// 从 stdin 读取
var reader = std.fs.File.stdin().reader(&buffer);
const input = try reader.takeDelimiterExclusive('\n');
```

## 缓冲 IO

### 工作原理
- **非缓冲 IO**：每次操作都进行系统调用（性能差）
- **缓冲 IO**：批量读写数据，减少系统调用（性能好）
- Zig 0.15+ 默认使用缓冲 IO，需显式提供缓冲区

### 注意事项
⚠️ **写操作必须调用 `flush()`** 来提交缓冲区数据到目标

## 文件系统操作

### 基本概念
- **CWD（当前工作目录）**：程序执行时的起始目录
- **路径类型**：
  - 绝对路径：从根目录开始（Windows: `C:/...`, Unix: `/...`）
  - 相对路径：从 CWD 开始
- **路径通配符**：`.`（当前目录）、`..`（上级目录）

### 目录处理器
```zig
const cwd = std.fs.cwd();  // 获取 CWD 处理器
```

## 文件操作

### 创建文件
```zig
const file = try cwd.createFile("foo.txt", .{ .read = true });
defer file.close();  // 必须关闭文件
```

### 打开文件
```zig
const file = try cwd.openFile("foo.txt", .{ .mode = .read_write });
defer file.close();
```
模式选项：`read_only`, `write_only`, `read_write`

### 其他操作
```zig
// 删除
try cwd.deleteFile("foo.txt");

// 复制
try cwd.copyFile("source.txt", cwd, "dest.txt", .{});
```

## 位置指示器
文件描述符的"游标"，标识当前读写位置：

```zig
file.seekTo(0);          // 移到开头
file.seekFromEnd(-10);   // 移到末尾前10字节
file.seekBy(20);         // 从当前位置前进20字节
```

## 目录操作

### 遍历文件
```zig
const dir = try cwd.openDir("path/", .{ .iterate = true });
var it = dir.iterate();  // 非递归
// var it = dir.walk();   // 递归遍历子目录

while (try it.next()) |entry| {
    std.debug.print("{s}\n", .{entry.name});
}
```

### 创建/删除目录
```zig
try cwd.makeDir("single");           // 创建单个目录
try cwd.makePath("path/to/nested");  // 递归创建路径
try cwd.deleteDir("path");           // 删除目录
```

## 完整示例

```zig
const std = @import("std");

pub fn main() !void {
    const cwd = std.fs.cwd();

    // 创建并写入文件
    const file = try cwd.createFile("test.txt", .{ .read = true });
    defer file.close();

    var buffer: [1024]u8 = undefined;
    var writer = file.writer(&buffer);
    try writer.writeAll("Hello, Zig!\n");
    try writer.flush();

    // 读取文件内容
    try file.seekTo(0);
    var reader = file.reader(&buffer);
    const content = try reader.readAll(buffer[0..]);

    // 输出到 stdout
    var stdout_writer = std.fs.File.stdout().writer(&buffer);
    try stdout_writer.print("File content: {s}", .{content});
    try stdout_writer.flush();
}
```

## 要点总结
1. 所有 IO 通过 `Reader`/`Writer` 对象进行
2. 始终关闭打开的文件（使用 `defer file.close()`）
3. 写操作后必须 `flush()` 缓冲区
4. 使用 `Dir` 对象进行文件系统操作
5. 注意文件的读写权限和模式设置
